const appDetails=chrome.app.getDetails();const repo="gadhagod/bell-schedule-extension";const req=new XMLHttpRequest;const time=new Date;const markdownConverter=new showdown.Converter;const header=document.getElementById("header");const scheduleTable=document.getElementById("schedule");const settings=document.getElementById("settings");const settingsForm=document.getElementById("settingsForm");const submitSettingsButton=document.getElementById("submitSettingsButton");const settingsBackButton=document.getElementById("settingsBackButton");const lunchBackButton=document.getElementById("lunchBackButton");const newReleaseBackButton=document.getElementById("newReleaseBackButton");const newReleaseButton=document.getElementById("newReleaseButton");const newReleaseText=document.getElementById("newReleaseText");const noWifiImage=document.getElementById("noWifiImage");const noWifiText=document.getElementById("noWifiText");const footer=document.getElementById("footer");const loader=document.getElementById("loader");const lunchTable=document.getElementById("lunch");const copyrightYear=document.getElementById("copyrightYear");function getEmptyPeriodNames(){return{P1:null,P2:null,P3:null,P4:null,P5:null,P6:null,P7:null}}function toTitleCase(str){return!str?null:str.toLowerCase().split(" ").map(function(word){return word.charAt(0).toUpperCase()+word.slice(1)}).join(" ")}function checkVersioning(){let url=`https://api.github.com/repos/${repo}/releases/latest`;req.onreadystatechange=function(){if(this.readyState===4&&this.status===200){let latestRelease=JSON.parse(this.responseText);if(latestRelease.name!==appDetails.version){newReleaseButton.style.display="block"}}};req.open("GET",url,true);req.send()}function loadSchedule(){scheduleTable.innerHTML="";header.innerHTML=`${parseWeekday(time.getDay())} ${time.getMonth()+1}/${time.getDate()}`+(time.getFullYear()!=(new Date).getFullYear()?`/${time.getFullYear()-2e3}`:"");chrome.storage.local.get(["periodNames"],function(res){let periodNames=res.periodNames??getEmptyPeriodNames();let url=`https://bell.dev.harker.org/api/schedule?year=${time.getFullYear()}&month=${time.getMonth()+1}&day=${time.getDate()}`;req.onreadystatechange=function(){if(this.readyState===4){if(this.status===200){(function(apiRes){let res=JSON.parse(apiRes.responseText);if(!res.schedule[0]||res.schedule[0].name==="No School"){scheduleTable.setAttribute("style","border:none;");scheduleTable.innerHTML="No school!";return}header.innerHTML+=`<br><small><span style="color:green">${(toTitleCase(res.variant)??"")+" "}</span>${res.code} Schedule</small>`;res.schedule.forEach(period=>{let periodIsFirstLunch=period.name.toLowerCase().includes("lunch")&&!scheduleTable.innerHTML.includes("lunch");let tr=document.createElement("tr");let td=document.createElement("td");td.innerHTML=`<center><b>${periodNames[period.name]??period.name}</b>${periodIsFirstLunch?" <a class='lunchButton' href='#'>&#x2197;</a>":""} ${parseTime(period.start)} - ${parseTime(period.end)}</center>`;if(periodStrings.includes(period.name)){td.setAttribute("class","nonPeriod")}tr.appendChild(td);scheduleTable.appendChild(tr);if(periodIsFirstLunch){document.querySelector(".lunchButton").addEventListener("click",setToLunchScreen)}})})(this)}else if(this.status===404){scheduleTable.setAttribute("style","border:none;");scheduleTable.innerHTML="No school!"}else{if(!this.status){header.innerHTML="";noWifiImage.style.display="block";noWifiText.innerHTML="No internet connection";settings.style.display="none";scheduleTable.parentNode.removeChild(scheduleTable)}else{document.write("An error occured")}}settings.addEventListener("click",setToSettingsScreen);loader.style.display="none"}};req.open("GET",url,true);req.send()})}function loadLunch(){lunchTable.innerHTML="";let url=`https://bell.dev.harker.org/api/lunchmenu?year=${time.getFullYear()}&month=${time.getMonth()+1}&day=${time.getDate()}`;req.onreadystatechange=function(){if(this.readyState===4){if(this.status===200){lunch=JSON.parse(this.responseText).lunch;lunch.forEach(item=>{lunchTable.appendChild((()=>{let row=document.createElement("tr");let foodLocation=document.createElement("td");foodLocation.innerHTML=`<b><center>${item.place}</center></b>`;let foodItem=document.createElement("td");foodItem.innerHTML=item.food;row.appendChild(foodLocation);row.appendChild(foodItem);return row})())})}else if(this.status===404){lunchTable.setAttribute("style","border:none");lunchTable.innerHTML="Lunch menu unavailable today!"}loader.style.display="none"}};req.open("GET",url,true);req.send()}function setToScheduleScreen(){loader.style.display="block";document.body.style.width="220px";scheduleTable.style.display="";settings.style.display="block";settingsForm.style.display="none";lunchTable.style.display="none";settingsBackButton.style.display="none";lunchBackButton.style.display="none";newReleaseButton.style.display="none";newReleaseText.style.display="none";newReleaseBackButton.style.display="none";footer.style.display="none";header.innerHTML="";scheduleTable.style.display="";scheduleTable.setAttribute("style","");loadSchedule()}function setToLunchScreen(){loader.style.display="block";lunchTable.style.display="block";lunchBackButton.style.display="block";scheduleTable.style.display="none";settings.style.display="none";loadLunch()}function setToSettingsScreen(){scheduleTable.style.display="none";settings.style.display="none";newReleaseText.style.display="none";settingsForm.style.display="block";settingsBackButton.style.display="block";header.innerHTML="Settings";newReleaseBackButton.style.display="none";lunchBackButton.style.display="none";footer.style.display="block";checkVersioning()}function setToNewVersionScreen(){scheduleTable.style.display="none";settings.style.display="none";settingsForm.style.display="none";newReleaseText.style.display="block";newReleaseBackButton.style.display="block";settingsBackButton.style.display="none";newReleaseButton.style.display="none";header.innerHTML="New Version Available";let url=`https://api.github.com/repos/${repo}/releases/latest`;req.onreadystatechange=function(){if(this.readyState===4&&this.status===200){let latestRelease=JSON.parse(this.responseText);let latestReleaseNotes=markdownConverter.makeHtml(latestRelease.body);newReleaseText.innerHTML=`A new version of the bell schedule extension is available. <br><br>
<u>Published on ${parseDate(latestRelease.published_at)}</u>
${latestReleaseNotes}
Please remove this extension and install <u>v${latestRelease.name}</u> from <a href="https://github.com/${repo}/releases/latest" target="_blank">here</a>. <br><br>
<small>NOTE: Updating extensions is highly recommended, as new features and fixes are implimemented.</small>`}};req.open("GET",url,true);req.send()}function parseTime(ISOTime){let str=ISOTime.substring(11,16);if(str.substring(0,1)==="0"){str=str.substring(1)}if(parseInt(str.substring(0,2))>12){str=str.replace(str.substring(0,2),(parseInt(str.substring(0,2))-12).toString())}return str}function parseDate(ISODateTime){return ISODateTime.substring(0,10)}function parseWeekday(dayNumber){return["Sun","Mon","Tue","Wed","Thur","Fri","Sat"][dayNumber]}var periodStrings=[];for(let i=1;i<=7;i++){periodStrings[i-1]=`P${i}`}chrome.storage.local.get(["periodNames"],function(res){let periodNames=res.periodNames;if(!periodNames){periodNames=getEmptyPeriodNames();chrome.storage.local.set(periodNames)}periodStrings.forEach(function(periodNumber){let customPeriodNameBox=document.getElementById(periodNumber);customPeriodNameBox.setAttribute("placeholder",periodNames[periodNumber]??"");let resetButton=document.getElementById(`${periodNumber}ResetButton`);resetButton.addEventListener("click",function(){document.getElementById(periodNumber).value="";document.getElementById(periodNumber).setAttribute("placeholder","");periodNames[periodNumber]=null;chrome.storage.local.set({periodNames:periodNames})})})});submitSettingsButton.addEventListener("click",function(){chrome.storage.local.get(["periodNames"],function(res){let periodNames=res.periodNames??getEmptyPeriodNames();periodStrings.forEach(function(periodNumber){let setClass=document.getElementById(periodNumber).value;if(setClass){periodNames[periodNumber]=document.getElementById(periodNumber).value;chrome.storage.local.set({periodNames:periodNames})}});setToScheduleScreen()})});newReleaseButton.addEventListener("click",setToNewVersionScreen);settingsBackButton.addEventListener("click",setToScheduleScreen);lunchBackButton.addEventListener("click",setToScheduleScreen);newReleaseBackButton.addEventListener("click",setToSettingsScreen);document.onkeydown=function(event){if(event.keyCode===39){time.setDate(time.getDate()+1)}else if(event.keyCode===37){time.setDate(time.getDate()-1)}else if(event.keyCode===40){time.setDate(time.getDate()+7)}else if(event.keyCode===38){time.setDate(time.getDate()-7)}else{return}setToScheduleScreen()};setToScheduleScreen();copyrightYear.innerHTML=time.getFullYear();